display:
  status:
    pomodoro:
      refresh: 60

      script: |
        MINUTES_PER_POMODORO = 25
        POMODOROS_PER_SESSION = 4
        @pomodoros ||= 0

        def start
          expired = Time.now >= @deadline if @deadline

          if not @started or expired
            @deadline = Time.now + (MINUTES_PER_POMODORO * 60)
            @started = true
            @paused = false
            @pomodoros += 1 if expired

          elsif @paused
            @deadline = Time.now + @paused
            @paused = false

          else
            @paused = @deadline - Time.now
          end

          refresh
        end

        def stop
          @started = false
          @paused = false
          refresh
        end

        def reset
          stop
          @pomodoros = 0
          refresh
        end

      label: |
        if @paused
          color = :notice
          minutes_remaining = "\u221E" # infinity

        elsif @started
          minutes_remaining = ((@deadline - Time.now) / 60).round

          if minutes_remaining == 0
            color = :success

            message =
              if (@pomodoros + 1) % POMODOROS_PER_SESSION == 0
                'Take a longer (10-20 minutes) break!'
              else
                'Take a short (5 minutes) break!'
              end
            dialog message, '-title', 'Pomodoro Technique'

          elsif minutes_remaining < 0
            color = :error
          end
        end

        [color, 'pomodoro',
          ("#{minutes_remaining}m" if minutes_remaining),
          ("x#{@pomodoros}" if @started),
        ].compact

      control:
        action:
          start_pomodoro: self.start
          stop_pomodoro: self.stop
          reset_pomodoro: self.reset

        mouse_action:
          left_click: start_pomodoro
          right_click: stop_pomodoro
          wheel_click: reset_pomodoro
