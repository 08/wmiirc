#!/usr/bin/ruby -w
# Loader for ruby-based wmii configuration.
=begin
  Copyright 2006 Suraj N. Kurapati

  This program is free software; you can redistribute it and/or
  modify it under the terms of the GNU General Public License
  as published by the Free Software Foundation; either version 2
  of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program; if not, write to the Free Software
  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
=end

require 'logger'

# Provide a means by which the user can rescue themselves after an exception.
def throw_life_saver aError
  system 'xterm &'

  IO.popen('xmessage -file - -buttons "recover from error:0,ignore this message:1"', 'w') do |f|
    f.puts aError.inspect, aError.backtrace
  end

  system($0 + ' &') if $?.exitstatus == 0
end


LOG = Logger.new(__FILE__ + '.log', 5)
LOG.info "starting"

# terminate existing instances of this program
  `ps -C #{File.basename $0} -o pid h`.split.
    map! {|s| s.to_i}.
    reject! {|pid| pid == $$}.
  each do |pid|
    LOG.info "stopping loader #{pid}"
    Process.kill :SIGTERM, pid
  end

# load the configuration
  Thread.abort_on_exception = true

  begin
    load File.join(File.dirname(__FILE__), 'wmiirc-config.rb')

  rescue => e
    LOG.error e
    throw_life_saver e

  rescue Exception => e
    LOG.fatal e
  end

LOG.info "stopping"
