#!/usr/bin/ruby -w
# Loader for ruby-based wmii configuration.
#--
# Copyright 2006 Suraj N. Kurapati
# See the file named LICENSE for details.

require 'logger'

# Provide a means by which the user can rescue themselves after an exception.
def throw_life_saver aError
  system 'xterm &'

  IO.popen('xmessage -file - -buttons "recover from error:0,ignore this message:1"', 'w') do |f|
    f.puts aError.inspect, aError.backtrace
  end

  system($0 + ' &') if $?.exitstatus == 0
end


LOG = Logger.new(__FILE__ + '.log', 5)
class << LOG
  alias write <<
end


LOG.info "birth"

# terminate existing instances of this program
  system 'wmiir xwrite /event Start wmiirc' # terminate them nicely

  instances = `ps -C #{File.basename $0} -o pid h`.split.map! {|s| s.to_i}
  instances.delete $$ # do not kill self!

  instances.each do |pid|
    LOG.info "slaying ##{pid}"
    Process.kill :SIGKILL, pid
  end

# load the configuration
  Thread.abort_on_exception = true

  begin
    $stdout = $stderr = LOG
    load File.join(File.dirname(__FILE__), 'wmiirc-config.rb')

  rescue => e
    LOG.error e
    throw_life_saver e

  rescue Exception => e
    LOG.fatal e
  end

LOG.info "death"
