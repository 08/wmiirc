control:
  action:

    launch_terminal: |
      #
      # Launch a new terminal and set its
      # working directory to be the same
      # as the currently focused terminal.
      #
      work = ENV['HOME']

      label = curr_client.label.read rescue ''

      # iterate in reverse order because
      # paths are usually at end of label
      label.split(' ').reverse_each do |s|
        #
        # If the currently focused client contains non-ASCII
        # characters in its title, then File.expand_path() raises
        # an EncodingError saying it cannot process the non-ASCII
        # string.  Try forcing the title's native encoding.
        #
        path = begin
          File.expand_path(s)
        rescue EncodingError => e
          File.expand_path(s.force_encoding(e.message[/\S+\z/]))
        end

        if File.exist? path
          unless File.directory? path
            path = File.dirname(path)
          end

          work = path
          break
        end
      end

      require 'fileutils'
      FileUtils.cd work do
        launch CONFIG['prefer']['terminal']
      end

    launch_browser: |
      launch CONFIG['prefer']['browser']

    launch_filer: |
      launch CONFIG['prefer']['filer']

    launch_editor: |
      launch CONFIG['prefer']['editor']
